<!DOCTYPE html>
<html>
	<head>
		<!-- Basic Page Info -->
		<meta charset="utf-8" />
		<title>IoT</title>

		<!-- Site favicon -->
		<link
			rel="apple-touch-icon"
			sizes="180x180"
			href="vendors/images/apple-touch-icon.png"
		/>
		<link
			rel="icon"
			type="image/png"
			sizes="32x32"
			href="vendors/images/favicon-32x32.png"
		/>
		<link
			rel="icon"
			type="image/png"
			sizes="16x16"
			href="vendors/images/favicon-16x16.png"
		/>

		<!-- Mobile Specific Metas -->
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1, maximum-scale=1"
		/>

		<!-- Google Font -->
		<link
			href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
			rel="stylesheet"
		/>
		<!-- CSS -->
		<link rel="stylesheet" type="text/css" href="vendors/styles/core.css" />
		<link
			rel="stylesheet"
			type="text/css"
			href="vendors/styles/icon-font.min.css"
		/>
		<link
			rel="stylesheet"
			type="text/css"
			href="src/plugins/datatables/css/dataTables.bootstrap4.min.css"
		/>
		<link
			rel="stylesheet"
			type="text/css"
			href="src/plugins/datatables/css/responsive.bootstrap4.min.css"
		/>
		<link rel="stylesheet" type="text/css" href="vendors/styles/style.css" />

		<!-- Global site tag (gtag.js) - Google Analytics -->
		<script
			async
			src="https://www.googletagmanager.com/gtag/js?id=G-GBZ3SGGX85"
		></script>
		<script
			async
			src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2973766580778258"
			crossorigin="anonymous"
		></script>
		<script>
			window.dataLayer = window.dataLayer || [];
			function gtag() {
				dataLayer.push(arguments);
			}
			gtag("js", new Date());

			gtag("config", "G-GBZ3SGGX85");
		</script>
		<!-- Google Tag Manager -->
		<script>
			(function (w, d, s, l, i) {
				w[l] = w[l] || [];
				w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
				var f = d.getElementsByTagName(s)[0],
					j = d.createElement(s),
					dl = l != "dataLayer" ? "&l=" + l : "";
				j.async = true;
				j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
				f.parentNode.insertBefore(j, f);
			})(window, document, "script", "dataLayer", "GTM-NXZMQSS");
		</script>
		<!-- End Google Tag Manager -->
	</head>
	<body>
		<div class="header">
			<div class="header-left">
				<div class="menu-icon bi bi-list"></div>
				<div
					class="search-toggle-icon bi bi-search"
					data-toggle="header_search"
				></div>

			</div>
			<div class="header-right">
				<div class="user-notification">
					<div class="dropdown">
						<a
							class="dropdown-toggle no-arrow"
							href="#"
							role="button"
							data-toggle="dropdown"
						>
							<i class="icon-copy dw dw-notification"></i>
							<span class="badge notification-active"></span>
						</a>
						<div class="dropdown-menu dropdown-menu-right">
							
						</div>
					</div>
				</div>
				<div class="user-info-dropdown">
					<div class="dropdown">
						<a
							class="dropdown-toggle"
							href="#"
							role="button"
							data-toggle="dropdown"
						>
							<span class="user-icon">
								<img src="vendors/images/photo1.jpg" alt="" />
							</span>
							<span class="user-name">Chang Kieu</span>
						</a>
						<div
							class="dropdown-menu dropdown-menu-right dropdown-menu-icon-list "
						>
							<a class="dropdown-item" href="profiles.html"
								><i class="dw dw-user1"></i> Profile</a
							>
							<a class="dropdown-item" href="login.html"
								><i class="dw dw-logout"></i> Log Out</a
							>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="left-side-bar">
			<div class="brand-logo">
				<a href="dashboard.html">
					<img src="vendors/images/deskapp-logo.svg" alt="" class="dark-logo" />
					<img
						src="vendors/images/deskapp-logo-white.svg"
						alt=""
						class="light-logo"
					/>
				</a>
				<div class="close-sidebar" data-toggle="left-sidebar-close">
					<i class="ion-close-round"></i>
				</div>
			</div>
			<div class="menu-block customscroll">
				<div class="sidebar-menu">
					<ul id="accordion-menu">
						<li class="dropdown">
							<a href="dashboard.html" class="dropdown-toggle no-arrow">
								<span class="micon bi bi-house"></span
								><span class="mtext">Trang chủ</span>
							</a>
						</li>
						<li class="dropdown">
							<a href="history.html" class="dropdown-toggle no-arrow">
								<span class="micon bi bi-receipt-cutoff"></span
								><span class="mtext">Lịch sử</span>
							</a>
						</li>
                        <li class="dropdown">
							<a href="data.html" class="dropdown-toggle no-arrow">
								<span class="micon bi bi-table"></span
								><span class="mtext">Dữ liệu</span>
							</a>
						</li>
					</ul>
				</div>
			</div>
		</div>

		<div class="main-container">
			<div class="xs-pd-20-10 pd-ltr-20">
				<div class="title pb-20">
					<h2 class="h3 mb-0"></h2>
				</div>

				<div class="row pb-10">
                    <div class="col-xl-3 col-lg-3 col-md-6 mb-20">
                        <div class="card-box height-100-p widget-style3">
                            <div class="d-flex flex-wrap">
                                <div class="widget-data">
                                    <div class="weight-700 font-24 text-dark" id="temperature">24°C</div>
                                    <div class="font-14 text-secondary weight-500">Nhiệt độ</div>
                                </div>
                                <div class="widget-icon">
                                    <div class="icon" data-color="#ff5733">
                                        <i class="fa fa-thermometer-half" aria-hidden="true"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-lg-3 col-md-6 mb-20">
                        <div class="card-box height-100-p widget-style3">
                            <div class="d-flex flex-wrap">
                                <div class="widget-data">
                                    <div class="weight-700 font-24 text-dark" id="humidity">65%</div>
                                    <div class="font-14 text-secondary weight-500">Độ ẩm</div>
                                </div>
                                <div class="widget-icon">
                                    <div class="icon" data-color="#3498db">
                                        <i class="fa fa-tint" aria-hidden="true"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-lg-3 col-md-6 mb-20">
                        <div class="card-box height-100-p widget-style3">
                            <div class="d-flex flex-wrap">
                                <div class="widget-data">
                                    <div class="weight-700 font-24 text-dark" id="light">450 lux</div>
                                    <div class="font-14 text-secondary weight-500">Ánh sáng</div>
                                </div>
                                <div class="widget-icon">
                                    <div class="icon" data-color="#f1c40f">
                                        <i class="fa fa-lightbulb-o" aria-hidden="true"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

				<div class="row pb-10">
                    <div class="col-md-9 mb-20">
                        <div class="card-box height-100-p pd-20">
                            <div class="d-flex flex-wrap justify-content-between align-items-center pb-0 pb-md-3">
                                <div class="h5 mb-md-0">Biểu đồ</div>
                            </div>
                            <div id="activities-chart"></div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-20 d-flex flex-column">
						<div class="card-box pd-20 d-flex align-items-center justify-content-between mb-10" style="background-color: #f1c40f; height: 120px;">
							<div class="d-flex align-items-center">
								<div class="icon h1 text-white mr-3">
									<i class="fa fa-lightbulb-o" aria-hidden="true"></i>
								</div>
								<div class="text-white font-16" style="margin-left: 10px;">Đèn <span id="led-count"></span></div> <!-- Hiển thị số lần bật tắt ở đây -->
							</div>
							<label class="switch">
								<input type="checkbox" id="light-toggle">
								<span class="slider round"></span>
							</label>
						</div>
						
						<div class="card-box pd-20 d-flex align-items-center justify-content-between mb-10" style="background-color: #2ecc71; height: 120px;">
							<div class="d-flex align-items-center">
								<div class="icon h1 text-white mr-3">
									<i class="bi bi-fan" aria-hidden="true"></i>
								</div>
								<div class="text-white font-16">Quạt <span id="fan-count"></span></div> <!-- Hiển thị số lần bật tắt ở đây -->
							</div>
							<label class="switch">
								<input type="checkbox" id="fan-toggle">
								<span class="slider round"></span>
							</label>
						</div>
						
						<div class="card-box pd-20 d-flex align-items-center justify-content-between mb-10" style="background-color: #3498db; height: 120px;">
							<div class="d-flex align-items-center">
								<div class="icon h1 text-white mr-3">
									<i class="fa fa-snowflake-o" aria-hidden="true"></i>
								</div>
								<div class="text-white font-16" style="margin-left: 5px;">Điều hòa <span id="ac-count"></span></div> <!-- Hiển thị số lần bật tắt ở đây -->
							</div>
							<label class="switch">
								<input type="checkbox" id="ac-toggle">
								<span class="slider round"></span>
							</label>
						</div>

						<!-- <div class="card-box pd-20 d-flex align-items-center justify-content-between mb-10" style="background-color: #9b59b6; height: 120px;">
							<div class="d-flex align-items-center">
								<div class="icon h1 text-white mr-3">
									<i class="fa fa-lightbulb-o" aria-hidden="true"></i>
								</div>
								<div class="text-white font-16" style="margin-left: 10px;">LED4 <span id="led4-count"></span></div>
							</div>
							<label class="switch">
								<input type="checkbox" id="led4-toggle">
								<span class="slider round"></span>
							</label>
						</div>

						<div class="card-box pd-20 d-flex align-items-center justify-content-between" style="background-color: #e67e22; height: 120px;">
							<div class="d-flex align-items-center">
								<div class="icon h1 text-white mr-3">
									<i class="fa fa-lightbulb-o" aria-hidden="true"></i>
								</div>
								<div class="text-white font-16" style="margin-left: 10px;">LED5 <span id="led5-count"></span></div>
							</div>
							<label class="switch">
								<input type="checkbox" id="led5-toggle">
								<span class="slider round"></span>
							</label>
						</div> -->

					</div>
					
                </div>
                

			</div>
		</div>
		<!-- welcome modal start -->

		<!-- welcome modal end -->
		<!-- js -->
		<script src="vendors/scripts/core.js"></script>
		<script src="vendors/scripts/script.min.js"></script>
		<script src="vendors/scripts/process.js"></script>
		<script src="vendors/scripts/layout-settings.js"></script>
		<script src="src/plugins/apexcharts/apexcharts.min.js"></script>
		<script src="src/plugins/datatables/js/jquery.dataTables.min.js"></script>
		<script src="src/plugins/datatables/js/dataTables.bootstrap4.min.js"></script>
		<script src="src/plugins/datatables/js/dataTables.responsive.min.js"></script>
		<script src="src/plugins/datatables/js/responsive.bootstrap4.min.js"></script>
		<noscript
			><iframe
				src="https://www.googletagmanager.com/ns.html?id=GTM-NXZMQSS"
				height="0"
				width="0"
				style="display: none; visibility: hidden"
			></iframe
		></noscript>
		<script>
			function updateSensorData() {
				fetch('http://localhost:3000/get_latest_data')
					.then(response => response.json())
					.then(data => {
						document.getElementById('temperature').innerText = data.temperature + "°C";
						document.getElementById('humidity').innerText = data.humidity + "%";
						document.getElementById('light').innerText = data.light + " lux";
					})
					.catch(error => console.error('Error fetching data:', error));
			}
			
			updateSensorData();
			
			setInterval(updateSensorData, 2000);

			function controlDevice(led, state) {
				fetch('http://localhost:3000/control_led', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({ led: led, state: state })
				})
				.then(response => response.json())
				.then(data => {
					console.log('✅ Điều khiển thành công:', data.message);
				})
			}

			document.getElementById('light-toggle').addEventListener('change', function () {
				const state = this.checked ? 'ON' : 'OFF';
				controlDevice('led1', state);
			});

			document.getElementById('fan-toggle').addEventListener('change', function () {
				const state = this.checked ? 'ON' : 'OFF';
				controlDevice('led2', state);
			});

			document.getElementById('ac-toggle').addEventListener('change', function () {
				const state = this.checked ? 'ON' : 'OFF';
				controlDevice('led3', state);
			});
			// document.getElementById('led4-toggle').addEventListener('change', function () {
			// 	const state = this.checked ? 'ON' : 'OFF';
			// 	controlDevice('led4', state);
			// });
			// document.getElementById('led5-toggle').addEventListener('change', function () {
			// 	const state = this.checked ? 'ON' : 'OFF';
			// 	controlDevice('led5', state);
			// });

		let chart; 

		function fetchAndUpdateChart() {
			fetch('http://localhost:3000/get_list_data')
			.then(response => response.json())
			.then(data => {
				const reversedData = data.slice().reverse();

				const temperatures = reversedData.map(item => item.temperature);
				const humidities = reversedData.map(item => item.humidity);
				const lights = reversedData.map(item => item.light);
				const times = reversedData.map(item => {
				const date = new Date(item.recorded_at);
				const hours = date.getHours().toString().padStart(2, '0');
				const minutes = date.getMinutes().toString().padStart(2, '0');
				return `${hours}:${minutes}`;
				});

				const options = {
				series: [
					{ name: "Nhiệt độ (°C)", data: temperatures },
					{ name: "Độ ẩm (%)", data: humidities },
					{ name: "Ánh sáng (lux)", data: lights }
				],
				chart: {
					height: 300,
					type: 'line',
					zoom: { enabled: false },
					dropShadow: {
					enabled: true,
					color: '#000',
					top: 10,
					left: 5,
					blur: 10,
					opacity: 0.2
					},
					toolbar: { show: false }
				},
				colors: ['#ff5733', '#3498db', '#f1c40f'],
				dataLabels: { enabled: false },
				stroke: { width: [3, 3, 3], curve: 'smooth' },
				grid: { show: false },
				markers: {
					colors: ['#ff5733', '#3498db', '#f1c40f'],
					size: 5,
					strokeColors: '#ffffff',
					strokeWidth: 2,
					hover: { sizeOffset: 2 }
				},
				xaxis: {
					categories: times,
					labels: {
					style: { colors: '#8c9094' }
					}
				},
				yaxis: {
					labels: {
					style: { colors: '#8c9094' }
					}
				},
				legend: {
					position: 'top',
					horizontalAlign: 'right',
					floating: true,
					offsetY: 0,
					labels: { useSeriesColors: true },
					markers: { width: 10, height: 10 }
				}
				};

				if (!chart) {
				// Nếu chưa khởi tạo, tạo mới
				chart = new ApexCharts(document.querySelector("#activities-chart"), options);
				chart.render();
				} else {
				// Nếu đã có chart, cập nhật dữ liệu
				chart.updateOptions(options);
				}
			})
			.catch(error => console.error('Lỗi khi lấy dữ liệu từ API:', error));
		}

		// Lần đầu chạy
		fetchAndUpdateChart();

		// Cập nhật mỗi 2 giây
		setInterval(fetchAndUpdateChart, 2000);

		function getLedCounts() {
        fetch('http://localhost:3000/get_led_counts')
            .then(response => response.json())
            .then(data => {

                document.getElementById('led-count').textContent = `(${data.led1Count})`;
                document.getElementById('fan-count').textContent = `(${data.led2Count})`;
                document.getElementById('ac-count').textContent = `(${data.led3Count})`;
				// document.getElementById('led4-count').textContent = `(${data.led4Count})`;
				// document.getElementById('led5-count').textContent = `(${data.led5Count})`;
            })
            .catch(error => {
                console.error('Có lỗi xảy ra khi lấy dữ liệu: ', error);
            });
    }

    // Gọi API khi tải trang xong
    getLedCounts();

    // Gọi API sau mỗi khoảng thời gian nếu cần cập nhật liên tục (ví dụ: mỗi 5 giây)
    setInterval(getLedCounts, 5000);
			</script>
	</body>
</html>
